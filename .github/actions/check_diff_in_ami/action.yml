name: Check Difference in AMI Name

runs:
  using: 'composite'
  steps:
    - name: Latest AMI Name For ubuntu-jammy-22.04-amd64-server
      id: latest_ami_name
      shell: bash
      working-directory: ./
      run: |
        ami_name=$(aws ec2 describe-images \
        --owners 099720109477 \
        --filters "Name=name,Values=ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*" \
        --query 'Images | sort_by(@, &CreationDate) | [-1].[Name]' \
        --output text \
        | grep -o 'ubuntu-jammy-22.04-amd64-server-[^/]*')
        echo "Latest AMI Name --> ${ami_name}"
        echo "ami_name=$latest_ami_name" >> $GITHUB_OUTPUT
        
    - name: Current Base AMI Name
      id: current_ami_name
      shell: bash
      working-directory: ./work
      run: |
        ami_name=$(cat ./variables.json | jq -r .ubuntu_ami_version)
        echo "Current Base AMI Name --> ${ami_name}"
        echo "ami_name=$ami_name" >> $GITHUB_OUTPUT

    - name: Check Difference in AMI Name
      id: check_difference_in_ami_name
      shell: bash
      run: |
          if [ "${{ steps.latest_ami_name.outputs.ami_name }}" != "${{ steps.current_ami_name.outputs.ami_name }}" ]; then
            echo "is_diff=true" >> $GITHUB_OUTPUT
          else
            echo "is_diff=false" >> $GITHUB_OUTPUT
          fi